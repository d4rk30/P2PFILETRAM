# P2P 文件传输系统 - 第一阶段

## 项目简介

这是一个基于局域网的P2P文件传输系统的第一阶段实现。本阶段主要实现节点发现功能，为后续的文件传输功能奠定基础。

## 第一阶段功能

- ✅ UDP广播节点发现机制
- ✅ 自动维护在线节点列表  
- ✅ 实时监控节点上线/下线状态
- ✅ 命令行交互界面(CLI)
- ✅ 多线程并发处理
- ✅ 线程安全的邻居表管理
- ✅ 防止自发现机制

## 文件结构

```
p2p/
├── main.py         # 程序入口，CLI循环和节点管理
├── broadcast.py    # 广播发送线程
├── listener.py     # 广播监听线程  
├── neighbors.py    # 邻居表管理
├── utils.py        # 工具函数
└── README.md       # 项目说明文档
```

## 安装和运行

### 环境要求
- Python 3.6+
- 支持UDP广播的局域网环境

### 运行方式

1. **基本启动**
```bash
python main.py
```

2. **指定参数启动**
```bash
# 指定端口
python main.py -p 12001

# 指定节点名称
python main.py -n "我的节点"

# 指定广播端口
python main.py -b 23334

# 组合参数
python main.py -p 12001 -n "节点A" -b 23334
```

3. **查看帮助**
```bash
python main.py --help
```

## CLI命令

启动后可在 `P2P>` 提示符下输入以下命令：

| 命令     | 简写  | 功能             |
| -------- | ----- | ---------------- |
| `peers`  | `p`   | 显示在线节点列表 |
| `status` | `s`   | 显示节点运行状态 |
| `info`   | `i`   | 显示本节点信息   |
| `help`   | `h`   | 显示帮助信息     |
| `clear`  | `cls` | 清屏             |
| `exit`   | `q`   | 退出程序         |

## 测试方法

### 单机测试
1. 打开多个终端窗口
2. 在每个窗口中使用不同端口启动节点：
```bash
# 终端1
python main.py -p 12000 -n "节点1"

# 终端2  
python main.py -p 12001 -n "节点2"

# 终端3
python main.py -p 12002 -n "节点3"
```

### 局域网测试
1. 在不同计算机上运行程序
2. 确保防火墙允许UDP广播（端口23333）
3. 使用 `peers` 命令查看发现的节点

## 技术特性

### 网络通信
- **传输协议**: UDP（用于节点发现广播）
- **广播地址**: 255.255.255.255
- **默认端口**: 23333（广播端口）
- **消息格式**: JSON序列化

### 并发处理
- **广播发送线程**: 每3秒发送一次心跳广播
- **广播监听线程**: 持续监听其他节点广播
- **清理线程**: 每5秒清理超时节点（10秒超时）
- **主线程**: CLI交互处理

### 安全特性
- 防止自发现（忽略本机IP的广播）
- 线程安全的数据结构操作
- 异常处理和优雅关闭
- 信号处理（Ctrl+C安全退出）

## 工作原理

1. **节点启动**: 获取本机IP，初始化各个组件
2. **广播发送**: 周期性向局域网广播自身信息
3. **广播监听**: 接收其他节点广播，更新邻居表  
4. **节点管理**: 维护在线节点列表，自动清理离线节点
5. **CLI交互**: 提供用户命令接口查看节点状态

## 示例输出

```
============================================================
P2P 文件传输系统 - 第一阶段
============================================================
节点信息:
  名称: node_100
  IP地址: 192.168.1.100
  端口: 12000
  广播端口: 23333
============================================================
[信息] 广播监听器已启动，监听端口: 23333
[信息] 正在监听广播端口 23333
[信息] 广播发送器已启动，端口: 23333
[信息] P2P节点启动成功！
[提示] 输入 'help' 查看可用命令
============================================================
[发现] 新节点上线: node_101 (192.168.1.101:12001) - Darwin
P2P> peers
============================================================
在线节点列表:
============================================================
节点名称        IP地址          端口    最后心跳      平台      
------------------------------------------------------------
node_101        192.168.1.101   12001   14:23:45     Darwin    
------------------------------------------------------------
总计: 1 个节点在线
============================================================
```

## 后续阶段规划

- 第二阶段：文件传输请求机制
- 第三阶段：TCP文件传输实现  
- 第四阶段：用户确认和安全控制
- 第五阶段：完整的P2P文件传输系统

## 注意事项

1. 确保网络环境支持UDP广播
2. 防火墙需要开放广播端口（默认23333）
3. 当前版本仅支持节点发现，不支持文件传输
4. 推荐在局域网环境中测试使用

## 故障排除

### 常见问题

**Q: 发现不了其他节点？**
A: 检查防火墙设置，确保UDP端口23333未被阻塞

**Q: 程序启动失败？**  
A: 检查端口是否被占用，尝试使用不同端口启动

**Q: 节点频繁上线下线？**
A: 检查网络稳定性，确认UDP广播包没有被丢失 