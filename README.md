# P2P 文件传输系统 - 第一阶段

## 项目简介

这是一个基于局域网的P2P文件传输系统的第一阶段实现。本阶段主要实现节点发现功能，为后续的文件传输功能奠定基础。系统采用UDP广播进行节点发现，支持多节点同时运行，具备完善的CLI交互界面。

## 功能特性

### ✅ 核心功能
- **UDP广播节点发现**: 每3秒自动发送心跳广播，维护节点在线状态
- **智能节点命名**: 自动生成唯一节点名称（node_1, node_2...），避免命名冲突
- **实时邻居管理**: 自动维护在线节点列表，10秒超时自动清理离线节点
- **多节点支持**: 支持同机不同端口多节点运行，正确识别和管理
- **线程安全**: 使用锁机制保护共享数据结构，确保并发安全

### ✅ 用户界面
- **清晰的启动信息**: 显示节点基本信息（名称、IP、端口、OS等）
- **丰富的CLI命令**: 支持status、peers、info、help等命令及简写
- **美观的状态显示**: 使用表格和树形结构展示节点信息
- **智能提示符**: 显示当前节点名称（如"node_1>"）

### ✅ 技术特性
- **防自发现机制**: 正确过滤自身广播，避免将自己加入邻居列表
- **异常处理**: 完善的错误处理和优雅退出机制
- **信号处理**: 支持Ctrl+C安全退出，自动清理资源
- **跨平台支持**: 支持Windows、macOS、Linux等操作系统

## 文件结构

```
p2p/
├── main.py         # 程序入口，CLI循环和节点管理
├── broadcast.py    # UDP广播发送线程
├── listener.py     # UDP广播监听线程  
├── neighbors.py    # 线程安全的邻居表管理
├── utils.py        # 工具函数（IP获取、命名、序列化等）
├── test_demo.py    # 多节点测试演示脚本
└── README.md       # 项目说明文档
```

## 安装和运行

### 环境要求
- Python 3.6+
- 支持UDP广播的局域网环境

### 运行方式

1. **基本启动**
```bash
python main.py
```

2. **指定参数启动**
```bash
# 指定端口
python main.py -p 12001

# 指定节点名称  
python main.py -n "我的节点"

# 指定广播端口
python main.py -b 23334

# 组合参数
python main.py -p 12001 -n "节点A" -b 23334
```

3. **查看帮助**
```bash
python main.py --help
```

## CLI命令

启动后可在节点提示符下输入以下命令：

| 命令     | 简写  | 功能                       |
| -------- | ----- | -------------------------- |
| `status` | `s`   | 显示节点运行状态和组件状态 |
| `peers`  | `p`   | 显示在线节点列表           |
| `info`   | `i`   | 显示本节点详细信息         |
| `help`   | `h`   | 显示帮助信息               |
| `clear`  | `cls` | 清屏                       |
| `quit`   | `q`   | 退出程序                   |

## 测试和演示

### 1. 单机多节点测试
```bash
# 终端1 - 启动第一个节点
python main.py -p 12000

# 终端2 - 启动第二个节点
python main.py -p 12001

# 终端3 - 启动第三个节点  
python main.py -p 12002
```

### 2. 使用测试脚本
```bash
# 自动启动多个测试节点
python test_demo.py
```
测试脚本会启动3个节点，其中节点1在前台可交互，节点2和3在后台运行。

### 3. 局域网测试
在不同计算机上运行程序，确保防火墙允许UDP广播（端口23333）。

## 技术实现

### 网络架构
- **传输协议**: UDP（用于节点发现广播）
- **广播地址**: 255.255.255.255
- **默认广播端口**: 23333
- **消息格式**: JSON序列化
- **节点标识**: IP:Port组合唯一标识

### 并发设计
- **广播发送线程**: 每3秒发送心跳广播
- **广播监听线程**: 持续监听其他节点广播
- **邻居清理线程**: 每5秒清理超时节点（10秒超时）
- **主线程**: CLI交互和程序控制

### 关键算法
- **智能命名**: 自动检测现有节点名称，生成不冲突的新名称
- **节点识别**: 使用IP:Port组合作为节点唯一键，支持同IP多端口
- **状态维护**: 基于时间戳的节点活跃状态管理
- **线程安全**: 使用threading.Lock保护共享数据结构

## 工作流程

1. **启动阶段**: 
   - 获取本机IP地址和空闲端口
   - 生成唯一节点名称
   - 初始化邻居管理器和各线程组件

2. **发现阶段**:
   - 启动广播监听线程，监听23333端口
   - 启动广播发送线程，每3秒发送心跳
   - 启动邻居清理线程，定期清理离线节点

3. **运行阶段**:
   - 处理接收到的节点广播，更新邻居表
   - 响应用户CLI命令，显示系统状态
   - 维护节点列表，自动处理上线/下线

4. **退出阶段**:
   - 捕获退出信号，停止所有后台线程
   - 清理网络资源，保存必要状态
   - 优雅退出程序

## 示例输出

### 启动信息
```
==============================================================
P2P 文件传输系统 - 第一阶段
==============================================================
节点信息:
  名称: node_1
  IP地址: 192.168.1.100  
  端口: 12000
  广播端口: 23333
  操作系统: Darwin
  启动时间: 2024-01-15 14:23:30
==============================================================
[信息] 广播监听器已启动，监听端口: 23333
[信息] 广播发送器已启动，端口: 23333  
[信息] 邻居清理器已启动
[信息] P2P节点启动成功！
[提示] 输入 'help' 查看可用命令
==============================================================
```

### 状态显示
```
node_1> status
==============================================================
节点运行状态
==============================================================
├─ 系统状态
│  ├─ 运行时长: 00:05:23
│  ├─ 节点名称: node_1
│  └─ 本机地址: 192.168.1.100:12000
└─ 组件状态  
   ├─ 广播监听器: ✓ 运行中
   ├─ 广播发送器: ✓ 运行中
   └─ 邻居清理器: ✓ 运行中
==============================================================
```

### 节点列表
```
node_1> peers
==============================================================
在线节点列表
==============================================================
节点名称        IP地址          端口    最后心跳      平台      
------------------------------------------------------------
node_2          192.168.1.101   12001   14:23:45     Darwin    
node_3          192.168.1.102   12002   14:23:44     Linux     
------------------------------------------------------------
总计: 2 个节点在线
==============================================================
```

## 故障排除

### 常见问题

**Q: 发现不了其他节点？**
A: 
- 检查防火墙设置，确保UDP端口23333未被阻塞
- 确认各节点在同一局域网内
- 检查网络是否支持UDP广播

**Q: 程序启动失败？**  
A:
- 检查端口是否被占用，尝试使用 `-p` 参数指定不同端口
- 确认Python版本满足要求（3.6+）
- 检查是否有必要的网络权限

**Q: 节点频繁上线下线？**
A:
- 检查网络稳定性，确认UDP广播包没有被丢失
- 调整防火墙设置，避免间歇性阻塞
- 检查系统负载，确保程序有足够资源运行

**Q: 同机多节点无法互相发现？**
A:
- 确保使用不同的端口号启动各节点
- 检查是否正确配置了SO_REUSEPORT选项
- 确认防自发现机制工作正常

## 开发说明

### 已解决的关键问题
1. **端口冲突**: 通过SO_REUSEPORT选项解决同机多节点监听冲突
2. **节点发现失效**: 修复防自发现逻辑，支持同IP不同端口节点发现  
3. **命名冲突**: 实现智能命名系统，自动避免节点名称重复
4. **状态管理**: 使用IP:Port组合作为唯一标识，避免节点覆盖问题
5. **UI/UX优化**: 统一界面风格，增强用户体验

### 代码质量
- 完善的异常处理和错误恢复机制
- 详细的日志记录和调试信息  
- 清晰的代码结构和注释文档
- 线程安全的数据操作

## 后续阶段规划

- **第二阶段**: 文件传输请求和响应机制
- **第三阶段**: TCP文件传输实现和进度监控
- **第四阶段**: 用户确认机制和安全控制
- **第五阶段**: 完整的P2P文件传输系统集成

## 注意事项

1. 当前版本仅实现节点发现功能，不支持文件传输
2. 建议在局域网环境中使用，广域网需要额外配置
3. 确保网络环境支持UDP广播通信
4. 大规模部署时注意广播风暴问题
5. 生产环境使用时建议添加认证和加密机制 